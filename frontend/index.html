<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI ALPHA PULSE</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0f; color: #e0e0e0; font-family: 'Courier New', monospace; }
  header { background: #0d0d1a; border-bottom: 1px solid #1a1a3e; padding: 16px 32px;
    display: flex; justify-content: space-between; align-items: center; }
  h1 { color: #7c3aed; font-size: 1.4rem; letter-spacing: 2px; }
  .badge { background: #7c3aed22; color: #7c3aed; border: 1px solid #7c3aed55;
    padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; }
  .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .card { background: #0d0d1a; border: 1px solid #1a1a3e; border-radius: 12px; padding: 20px;
    transition: border-color 0.2s; }
  .card:hover { border-color: #7c3aed55; }
  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .ticker { font-size: 1.1rem; font-weight: bold; color: #fff; }
  .exchange { font-size: 0.7rem; color: #666; }
  .score-big { font-size: 2.5rem; font-weight: bold; text-align: center; margin: 12px 0; }
  .score-pos { color: #22c55e; }
  .score-neg { color: #ef4444; }
  .score-neu { color: #f59e0b; }
  .signal { text-align: center; font-size: 0.8rem; letter-spacing: 1px; padding: 4px 12px;
    border-radius: 20px; display: inline-block; width: 100%; margin-bottom: 12px; }
  .sig-sb { background: #22c55e22; color: #22c55e; border: 1px solid #22c55e44; }
  .sig-b  { background: #86efac22; color: #86efac; border: 1px solid #86efac44; }
  .sig-n  { background: #f59e0b22; color: #f59e0b; border: 1px solid #f59e0b44; }
  .sig-s  { background: #f8717122; color: #f87171; border: 1px solid #f8717144; }
  .sig-ss { background: #ef444422; color: #ef4444; border: 1px solid #ef444444; }
  .factors { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .factor { background: #ffffff08; border-radius: 8px; padding: 8px; text-align: center; }
  .factor-label { font-size: 0.65rem; color: #666; margin-bottom: 4px; text-transform: uppercase; }
  .factor-val { font-size: 0.9rem; font-weight: bold; }
  .explanation { font-size: 0.7rem; color: #888; margin-top: 10px; border-top: 1px solid #1a1a3e;
    padding-top: 8px; }
  .table-wrap { background: #0d0d1a; border: 1px solid #1a1a3e; border-radius: 12px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  th { background: #12122a; color: #666; font-size: 0.7rem; text-transform: uppercase;
    letter-spacing: 1px; padding: 12px 16px; text-align: right; }
  th:first-child { text-align: left; }
  td { padding: 12px 16px; border-top: 1px solid #1a1a3e; text-align: right; font-size: 0.85rem; }
  td:first-child { text-align: left; }
  tr:hover td { background: #ffffff04; }
  .refresh-btn { background: #7c3aed; color: white; border: none; padding: 8px 20px;
    border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.8rem; }
  .refresh-btn:hover { background: #6d28d9; }
  .last-update { color: #555; font-size: 0.7rem; }
  h2 { color: #888; font-size: 0.85rem; letter-spacing: 2px; margin-bottom: 16px; text-transform: uppercase; }
  .loading { text-align: center; color: #555; padding: 40px; }
</style>
</head>
<body>
<header>
  <h1>‚ö° AI ALPHA PULSE</h1>
  <div style="display:flex;gap:12px;align-items:center">
    <span class="last-update" id="lastUpdate">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>
    <button class="refresh-btn" onclick="loadScores()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    <span class="badge">v0.2</span>
  </div>
</header>

<div class="container">
  <h2>üî• –¢–æ–ø –∞–∫—Ç–∏–≤–æ–≤</h2>
  <div class="grid" id="cardsGrid"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–æ—Ä–∏–Ω–≥–æ–≤...</div></div>

  <h2>üìä –¢–∞–±–ª–∏—Ü–∞ —Å–∫–æ—Ä–∏–Ω–≥–æ–≤</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>–ê–∫—Ç–∏–≤</th><th>–¢—Ä–µ–Ω–¥</th><th>–í–æ–ª–∞—Ç–∏–ª.</th>
          <th>AI SCORE</th><th>–°–∏–≥–Ω–∞–ª</th><th>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ</th>
        </tr>
      </thead>
      <tbody id="tableBody"><tr><td colspan="6" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
    </table>
  </div>
</div>

<script>
const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://127.0.0.1:8000' : '';

function scoreColor(s) {
  if (s >= 25) return 'score-pos';
  if (s <= -25) return 'score-neg';
  return 'score-neu';
}
function sigClass(s) {
  return {'STRONG BUY':'sig-sb','BUY':'sig-b','NEUTRAL':'sig-n','SELL':'sig-s','STRONG SELL':'sig-ss'}[s] || 'sig-n';
}
function sigEmoji(s) {
  return {'STRONG BUY':'üü¢üü¢','BUY':'üü¢','NEUTRAL':'üü°','SELL':'üî¥','STRONG SELL':'üî¥üî¥'}[s] || '‚ö™';
}

async function loadScores() {
  try {
    const r = await fetch(`${API}/scores`);
    const data = await r.json();
    const scores = data.scores || [];

    // Also fetch from /score/ for real-time if scores empty
    let items = scores;
    if (!items.length) {
      const assets = ['AAPL','MSFT','BTCUSDT','ETHUSDT','SBER'];
      items = await Promise.all(assets.map(t =>
        fetch(`${API}/score/${t}?asset_type=${['BTCUSDT','ETHUSDT','SOLUSDT'].includes(t)?'crypto':'stock'}`)
          .then(r=>r.json()).catch(()=>null)
      ));
      items = items.filter(Boolean);
    }

    renderCards(items);
    renderTable(items);
    document.getElementById('lastUpdate').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString('ru');
  } catch(e) {
    document.getElementById('cardsGrid').innerHTML = `<div class="loading">–û—à–∏–±–∫–∞: ${e.message}<br>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ API –∑–∞–ø—É—â–µ–Ω: uvicorn api.main:app</div>`;
  }
}

function renderCards(items) {
  const sorted = [...items].sort((a,b) => (b.ai_score||0)-(a.ai_score||0));
  document.getElementById('cardsGrid').innerHTML = sorted.map(item => {
    const ticker = item.ticker || item.asset?.ticker || '?';
    const name = item.name || item.asset?.name || ticker;
    const exchange = item.exchange || item.asset?.exchange || '';
    const ai = +(item.ai_score||0).toFixed(1);
    const trend = +(item.trend_score||0).toFixed(1);
    const vol = +(item.volatility_score||0).toFixed(1);
    const signal = item.signal || 'NEUTRAL';
    const expl = item.explanation || '';
    return `<div class="card">
      <div class="card-header">
        <div><div class="ticker">${ticker}</div><div class="exchange">${name} ¬∑ ${exchange}</div></div>
      </div>
      <div class="score-big ${scoreColor(ai)}">${ai > 0 ? '+' : ''}${ai}</div>
      <div style="text-align:center">
        <span class="signal ${sigClass(signal)}">${sigEmoji(signal)} ${signal}</span>
      </div>
      <div class="factors">
        <div class="factor"><div class="factor-label">–¢—Ä–µ–Ω–¥</div>
          <div class="factor-val ${scoreColor(trend)}">${trend>0?'+':''}${trend}</div></div>
        <div class="factor"><div class="factor-label">–í–æ–ª–∞—Ç–∏–ª.</div>
          <div class="factor-val ${scoreColor(vol)}">${vol>0?'+':''}${vol}</div></div>
      </div>
      ${expl ? `<div class="explanation">${expl}</div>` : ''}
    </div>`;
  }).join('');
}

function renderTable(items) {
  const sorted = [...items].sort((a,b)=>(b.ai_score||0)-(a.ai_score||0));
  document.getElementById('tableBody').innerHTML = sorted.map(item => {
    const ticker = item.ticker || item.asset?.ticker || '?';
    const ai = +(item.ai_score||0).toFixed(1);
    const trend = +(item.trend_score||0).toFixed(1);
    const vol = +(item.volatility_score||0).toFixed(1);
    const signal = item.signal || 'NEUTRAL';
    const expl = item.explanation || '‚Äî';
    return `<tr>
      <td><strong>${ticker}</strong></td>
      <td class="${scoreColor(trend)}">${trend>0?'+':''}${trend}</td>
      <td class="${scoreColor(vol)}">${vol>0?'+':''}${vol}</td>
      <td class="${scoreColor(ai)}" style="font-size:1.1rem;font-weight:bold">${ai>0?'+':''}${ai}</td>
      <td><span class="signal ${sigClass(signal)}" style="width:auto;padding:3px 10px">${sigEmoji(signal)} ${signal}</span></td>
      <td style="text-align:left;color:#888;font-size:0.75rem">${expl}</td>
    </tr>`;
  }).join('');
}

// Auto-refresh every 60 seconds
loadScores();
setInterval(loadScores, 60000);
</script>
</body>
</html>
